{% include 'index.html' with active='articles' %}
{% load static %}
{% block content %}

    <div class="container p-4 pt-3">

        {% include 'current_category_label.html' with active='Категории' %}

        <form action="{% url 'articles:find' %}">
            <div class="input-group mb-3"
                 style="border-radius: 20px; position: relative;">
                <div class='input-group' style="position: relative; overflow: hidden; margin-bottom: -10px; !important">
                    <input name="label__icontains" type="text"
                           class="form-control search-input custom-focus rounded-start-pill notes-component"
                           placeholder="Найти статью"
                           style="border-right: none; background-color: white"
                           autocomplete="off">
                    <button class="btn btn-outline-secondary rounded-end-circle notes-component"
                            style="border-left: none; background-color: white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="#113B3A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                             class="icon icon-tabler icons-tabler-outline icon-tabler-search">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/>
                            <path d="M21 21l-6 -6"/>
                        </svg>
                    </button>
                </div>
                <!-- Выпадающее меню результатов -->
                <ul class="dropdown-menu w-100 shadow-lg" id="search-dropdown"
                    style="display: none; max-height: 200px; overflow-y: auto; margin-top: -10px; z-index: 1;">
                    <div id="search-results"></div>
                </ul>
            </div>
        </form>

        {% include "open_categories_button.html" %}

        {% if objects  is not None %}
            <div class="row text-center justify-content-between">
                {% if objects|length > 0 %}
                    <h1 class="p-1">Найденные статьи</h1>
                    {% include "grid_articles_cards.html" with articles=objects %}
                {% else %}
                    <h1 class="p-1">Ничего не найдено</h1>
                {% endif %}
            </div>
        {% else %}
            <div class="pb-3 pt-3">
                {% include 'popular_articles_component.html' with popular_articles=popular_articles %}
            </div>
            <div class="pb-3">
                {% include 'favorite_articles_component.html' with favorite_articles=favorite_articles %}
            </div>
        {% endif %}
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const searchInput = document.querySelector(".search-input");
            const resultsContainer = document.querySelector("#search-results");
            const searchDropdown = document.querySelector("#search-dropdown");

            // Функция для показа/скрытия выпадающего меню
            function toggleDropdown(show) {
                searchDropdown.style.display = show ? "block" : "none";
            }

            // Закрытие меню при клике вне области
            document.addEventListener("click", function (e) {
                if (!e.target.closest(".input-group")) {
                    toggleDropdown(false);
                }
            });

            function debounce(func, delay) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            function performSearch() {
                const query = searchInput.value.trim();

                if (!query) {
                    resultsContainer.innerHTML = "";
                    toggleDropdown(false);
                    return;
                }

                toggleDropdown(true);

                fetch(`find_preview/?label__icontains=${encodeURIComponent(query)}`)
                    .then(response => {
                        if (!response.ok) throw new Error("Network response was not ok");
                        return response.text();
                    })
                    .then(html => {
                        resultsContainer.innerHTML = html;

                        // Добавляем обработчики для элементов меню
                        document.querySelectorAll("#search-dropdown .dropdown-item").forEach(item => {
                            item.addEventListener("click", function () {
                                toggleDropdown(false);
                            });
                        });
                    })
                    .catch(() => {
                        resultsContainer.innerHTML = `
                    <div class="dropdown-item text-danger">
                        Произошла ошибка. Попробуйте снова.
                    </div>`;
                    });
            }

            const debouncedSearch = debounce(performSearch, 300);

            searchInput.addEventListener("input", debouncedSearch);
            searchInput.addEventListener("focus", function () {
                if (searchInput.value.trim() && resultsContainer.innerHTML) {
                    toggleDropdown(true);
                }
            });
        });
    </script>
{% endblock %}