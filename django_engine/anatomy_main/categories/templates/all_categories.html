{% include 'index.html' with active='categories' %}
{% load static %}

{% block content %}
    <div class="container p-4">
        <form action="{% url 'atlases:find' %}">
            <div class="input-group mb-3"
                 style="border-radius: 20px; position: relative;">
                <div class='input-group' style="position: relative; overflow: hidden; margin-bottom: -10px; !important">
                    <input name="name__icontains" type="text"
                           class="form-control search-input custom-focus rounded-start-pill notes-component"
                           placeholder="Найти категорию"
                           style="border-right: none; background-color: white"
                           autocomplete="off">
                    <button class="btn btn-outline-secondary rounded-end-circle notes-component"
                            style="border-left: none; background-color: white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="#113B3A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                             class="icon icon-tabler icons-tabler-outline icon-tabler-search">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"/>
                            <path d="M21 21l-6 -6"/>
                        </svg>
                    </button>
                </div>
                <!-- Выпадающее меню результатов -->
                <ul class="dropdown-menu w-100 shadow-lg" id="search-dropdown"
                    style="display: none; max-height: 200px; overflow-y: auto; margin-top: -10px; z-index: 1;">
                    <div id="search-results"></div>
                </ul>
            </div>
        </form>


        {% if objects is not None %}
            <div class="row row-cols-1 row-cols-md-3 g-4 p-4 pt-3">
                {% if objects|length > 0 %}
                    <h1 class="p-0 text-center">Найденные категории</h1>
                    {% for catalog in objects %}
                        <div class="col">
                            <div class="card shadow-sm h-100">
                                <!-- Иконка или изображение категории -->
                                <div class="card-body">
                                    <h5 class="card-title">{{ catalog.name }}</h5>
                                    <p class="card-text text-muted">
                                        {{ catalog.description|truncatechars:100 }}
                                    </p>
                                    <a href="{{ catalog.get_absolute_url }}" class="btn btn-primary">Открыть</a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <h1 class="p-1 text-center">Ничего не найдено</h1>
                {% endif %}
            </div>
        {% else %}
            <h1 class="text-center">Все категории</h1>
            <!-- Сетка для категорий -->
            <div class="row row-cols-1 row-cols-md-3 g-4 pt-3">
                {% for catalog in popular_catalogs %}
                    <div class="col">
                        <div class="card shadow-sm h-100">
                            <!-- Иконка или изображение категории -->
                            <div class="card-body">
                                <h5 class="card-title">{{ catalog.name }}</h5>
                                <p class="card-text text-muted">
                                    {{ catalog.description|truncatechars:100 }}
                                </p>
                                <a href="{{ catalog.get_absolute_url }}" class="btn btn-primary">Открыть</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const searchInput = document.querySelector(".search-input");
            const resultsContainer = document.querySelector("#search-results");
            const searchDropdown = document.querySelector("#search-dropdown");

            // Функция для показа/скрытия выпадающего меню
            function toggleDropdown(show) {
                searchDropdown.style.display = show ? "block" : "none";
            }

            // Закрытие меню при клике вне области
            document.addEventListener("click", function (e) {
                if (!e.target.closest(".input-group")) {
                    toggleDropdown(false);
                }
            });

            function debounce(func, delay) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            function performSearch() {
                const query = searchInput.value.trim();

                if (!query) {
                    resultsContainer.innerHTML = "";
                    toggleDropdown(false);
                    return;
                }

                toggleDropdown(true);

                fetch(`find_preview/?name__icontains=${encodeURIComponent(query)}`)
                    .then(response => {
                        if (!response.ok) throw new Error("Network response was not ok");
                        return response.text();
                    })
                    .then(html => {
                        resultsContainer.innerHTML = html;

                        // Добавляем обработчики для элементов меню
                        document.querySelectorAll("#search-dropdown .dropdown-item").forEach(item => {
                            item.addEventListener("click", function () {
                                toggleDropdown(false);
                            });
                        });
                    })
                    .catch(() => {
                        resultsContainer.innerHTML = `
                    <div class="dropdown-item text-danger">
                        Произошла ошибка. Попробуйте снова.
                    </div>`;
                    });
            }

            const debouncedSearch = debounce(performSearch, 300);

            searchInput.addEventListener("input", debouncedSearch);
            searchInput.addEventListener("focus", function () {
                if (searchInput.value.trim() && resultsContainer.innerHTML) {
                    toggleDropdown(true);
                }
            });
        });
    </script>
    {#    <h1>Популярные категории</h1>#}
    {#    <ul>#}
    {#        {% for catalog in popular_catalogs %}#}
    {#            <li><a href="{{ catalog.get_absolute_url }}">{{ catalog.name }}</a></li>#}
    {#        {% endfor %}#}
    {#    </ul>#}
    {#    <a href="{% url 'categories:find' %}">Поиск</a>#}
{% endblock %}

