{% load static %}
{% block content %}
    {% for atlas in atlases %}
      <div class="col-6 p-1 text-start d-flex justify-content-center text-center">
        <div class="card draggable-lg border-0 shadow rounded-4 position-relative overflow-hidden">
          <a href="{{ atlas.get_absolute_url }}" style="text-decoration: none;">
            <img src="{% static atlas.atlas_file %}" class="card-img-top rounded-top-4" alt="..." onerror="this.src='{% static "alternate_imgs/kotek.png" %}'; this.onerror=null;">
          </a>

          <!-- Кнопки действий -->
          <div class="action-buttons position-absolute bottom-25 start-0 w-100 d-flex justify-content-end gap-2 px-2" style="z-index: 2; bottom: 60px">
            <!-- Избранное -->
            <button class="favorite-atlas-button btn p-1 d-flex align-items-center justify-content-center"
                    data-item-id="{{ atlas.id }}"
                    style="background-color: #345; border-radius: 0.5rem; width: 32px; height: 32px;">
{#            <img src="{% static 'icons/star_off.svg' %}" class="w-100 h-100 object-fit-contain" alt="★">#}
              {% if atlas.is_favorite %}
                <img src="{% static 'icons/star_off.svg' %}" class="w-100 h-100 object-fit-contain" alt="★">
              {% else %}
                <img src="{% static 'icons/star.svg' %}" class="w-100 h-100 object-fit-contain" alt="☆">
              {% endif %}
            </button>

            <!-- Поделиться -->
            <button class="share-atlas-button btn p-1 d-flex align-items-center justify-content-center"
                    style="background-color: #345; border-radius: 0.5rem; width: 32px; height: 32px;"
                    data-bs-toggle="modal"
                    data-bs-target="#shareModal"
                    data-atlas-id="{{ atlas.id }}"
                    data-atlas-label="{{ atlas.label|escapejs }}">
              <img src="{% static 'icons/share.svg' %}" class="w-100 h-100 object-fit-contain" alt="Share">
            </button>
          </div>

          <div class="card-body text-truncate">
            <span>{{ atlas }}</span>
          </div>
        </div>
      </div>
    {% endfor %}
    <!-- Модальное окно для выбора способа шаринга -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">Поделиться атласом</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-2">

                        <!-- Кнопка для системного шаринга -->
                        <button class="btn btn-primary shadow-lg" onclick="shareAtlasViaSystem()">
                            <i class="bi bi-share"></i> Через приложения
                        </button>

                        <!-- Кнопка для копирования ссылки -->
                        <button class="btn btn-primary shadow-lg"
                                onclick="copyAtlasLink(); $('#shareModal').modal('hide')">
                            <i class="bi bi-link-45deg"></i> Скопировать ссылку
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% csrf_token %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  $(document).ready(function () {
    $('.favorite-atlas-button').on('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      const buttonAtlas = $(this);
      const atlasId = buttonAtlas.data('item-id');

      // Запрос на добавление или удаление из избранного
      $.ajax({
        url: '/atlases/toggle_favorite_atlas/' + atlasId + '/',
        type: 'POST',
        headers: {
          'X-CSRFToken': csrftoken
        },
        success: function (response) {
          const icon = buttonAtlas.find('img');

          if (response.action === 'added') {
            icon.attr('src', "{% static 'icons/star_off.svg' %}");
          } else {
            icon.attr('src', "{% static 'icons/star.svg' %}");
          }
        },
        error: function (xhr, status, error) {
          console.error("Ошибка:", error);
        }
      });
    });
  });
</script>
<script>
    let currentAtlasId = null;
    let currentAtlasLabel = null;

    document.addEventListener('DOMContentLoaded', function () {
        // Обработчик нажатия на любую кнопку share-button
        document.querySelectorAll('.share-atlas-button').forEach(button => {
            button.addEventListener('click', function () {
                currentAtlasId = this.getAttribute('data-atlas-id');
                currentAtlasLabel = this.getAttribute('data-atlas-label');
            });
        });
    });

    // Генерация ссылки
    function generateAtlasShareLink() {
        return `https://t.me/vet_irit_bot?startapp=atlas_${currentAtlasId}`;
    }

    // Системный шаринг через Web Share API
    function shareAtlasViaSystem() {
        const shareData = {
            title: currentAtlasLabel || 'Атлас',
            text: 'Посмотрите этот атлас:',
            url: generateAtlasShareLink()
        };

        if (navigator.share) {
            navigator.share(shareData);
        } else {
            copyAtlasLink();
            alert('Ссылка скопирована в буфер обмена');
        }
    }

    // Копирование ссылки
    function copyAtlasLink() {
        const link = generateAtlasShareLink();
        navigator.clipboard.writeText(link).then(() => {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.showAlert('Ссылка скопирована!');
            }
        });
    }
</script>
{% endblock %}